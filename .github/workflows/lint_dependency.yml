name: Auto PR after Renovate Merge

on:
  push:
    branches:
      - main

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  GRADLE_CACHE: 'gradle'

jobs:
  create-follow-up-pr:
    runs-on: ubuntu-latest
    # Check if the push was from a renovate merge
    if: github.event.head_commit.author.name == 'renovate[bot]'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.BOT_PAT }}

      - name: Check if this is a renovate merge
        id: renovate_check
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_COMMITTER: ${{ github.event.head_commit.committer.name }}
        run: |
          # check for renovate commits using environment variables
          if [[ "$COMMIT_MESSAGE" =~ renovate ]] || \
             [[ "$COMMIT_AUTHOR" == "renovate[bot]" ]] || \
             [[ "$COMMIT_COMMITTER" == "renovate[bot]" ]]; then
            echo "is_renovate=true" >> $GITHUB_OUTPUT
            echo "This appears to be a Renovate merge"
          else
            echo "is_renovate=false" >> $GITHUB_OUTPUT
            echo "This is not a Renovate merge, skipping"
          fi

      - name: Set up JDK
        if: steps.renovate_check.outputs.is_renovate == 'true'
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: ${{ env.GRADLE_CACHE }}

      - name: Setup Google Services JSON, local.properties, and Gradle properties
        if: steps.renovate_check.outputs.is_renovate == 'true'
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > app/google-services.json
          echo "sdk.dir=$ANDROID_HOME" > $GITHUB_WORKSPACE/local.properties
          mkdir -p ~/.gradle ; cp .github/ci-gradle.properties ~/.gradle/gradle.properties

      # -------------------------------
      # Update lint baseline
      # -------------------------------
      - name: Run lint and update baseline
        if: steps.renovate_check.outputs.is_renovate == 'true'
        run: |
          ./gradlew updateLintBaseline --stacktrace || {
            echo "Lint baseline update failed, but continuing..."
            exit 0
          }

      - name: Check lint baseline changes
        if: steps.renovate_check.outputs.is_renovate == 'true'
        id: lint_diff
        run: |
          if git diff --quiet -- '**/lint-baseline.xml'; then
            echo "diff_found=false" >> $GITHUB_OUTPUT
            echo "No lint baseline changes found"
          else
            echo "diff_found=true" >> $GITHUB_OUTPUT
            echo "Lint baseline changes detected"
          
            # Create summary
            echo "## 🔍 Lint Baseline Changes" > lint-summary.md
            echo "" >> lint-summary.md
            echo "Updated after Renovate dependency changes." >> lint-summary.md
            echo "" >> lint-summary.md
          
            # List changed files
            echo "### Files changed:" >> lint-summary.md
            git diff --name-only -- '**/lint-baseline.xml' | sed 's/^/- `/' | sed 's/$/`/' >> lint-summary.md
          fi

      # -------------------------------
      # Update dependency baseline
      # -------------------------------
      - name: Run dependencyGuardBaseline
        if: steps.renovate_check.outputs.is_renovate == 'true'
        run: |
          ./gradlew dependencyGuardBaseline --stacktrace || {
            echo "Dependency guard baseline update failed, but continuing..."
            exit 0
          }

      - name: Check dependency baseline changes
        if: steps.renovate_check.outputs.is_renovate == 'true'
        id: dep_diff
        run: |
          if git diff --quiet -- '**/dependencies/*.txt'; then
            echo "diff_found=false" >> $GITHUB_OUTPUT
            echo "No dependency baseline changes found"
          else
            echo "diff_found=true" >> $GITHUB_OUTPUT
            echo "Dependency baseline changes detected"
          
            # Create summary
            echo "## 📦 Dependency Baseline Changes" > dep-summary.md
            echo "" >> dep-summary.md
            echo "Updated after Renovate dependency changes." >> dep-summary.md
            echo "" >> dep-summary.md
          
            # List changed files
            echo "### Files changed:" >> dep-summary.md
            git diff --name-only -- '**/dependencies/*.txt' | sed 's/^/- `/' | sed 's/$/`/' >> dep-summary.md
          fi

      # -------------------------------
      # Create PR only if there are changes
      # -------------------------------
      - name: Create Pull Request
        if: steps.renovate_check.outputs.is_renovate == 'true' && (steps.lint_diff.outputs.diff_found == 'true' || steps.dep_diff.outputs.diff_found == 'true')
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e
        with:
          token: ${{ secrets.BOT_PAT }}
          commit-message: "chore(ci): update baselines after renovate merge"
          branch: auto/update-baselines
          delete-branch: true
          title: "🔄 Update baselines after Renovate changes"
          body: |
            ## 🤖 Automated Baseline Updates
            
            This PR was automatically created after Renovate merged dependency updates to `main`.
            
            ### Changes included:
            ${{ steps.lint_diff.outputs.diff_found == 'true' && '- ✅ Updated lint baselines' || '' }}
            ${{ steps.dep_diff.outputs.diff_found == 'true' && '- ✅ Updated dependency baselines' || '' }}
            
            ### Why this PR exists
            After Renovate updates dependencies, the project's lint rules and dependency guard baselines 
            may need updates to reflect the new dependency versions and any new lint issues they introduce.
            
            ### Next steps
            - Review the baseline changes
            - Merge this PR to keep baselines in sync
            
            ---
            
            > **Note**: This PR was created by the `Auto PR after Renovate Merge` workflow
            > Triggered by commit: ${{ github.event.head_commit.id }}
          labels: |
            dependencies
            automated
            chore
          draft: false

      - name: Log PR creation result
        if: steps.renovate_check.outputs.is_renovate == 'true'
        run: |
          if [[ "${{ steps.lint_diff.outputs.diff_found }}" == "true" || "${{ steps.dep_diff.outputs.diff_found }}" == "true" ]]; then
            echo "✅ PR should have been created with baseline updates"
          else
            echo "ℹ️ No baseline changes detected, no PR created"
          fi

      #  Run a quick build test to ensure changes are valid
      - name: Test build with updated baselines
        if: steps.renovate_check.outputs.is_renovate == 'true' && (steps.lint_diff.outputs.diff_found == 'true' || steps.dep_diff.outputs.diff_found == 'true')
        run: |
          echo "Running quick build test..."
          ./gradlew assemble --stacktrace
